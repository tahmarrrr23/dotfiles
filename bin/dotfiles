#!/bin/bash

set -eu

DOTFILES_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
DOTFILES_SRC_ROOT="$DOTFILES_ROOT/src"

if [ -f "/opt/homebrew/bin/brew" ]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
else
  printf "Please install Homebrew\n"
  exit 1
fi

link_config() {
  local src=$1 dst=$2
  rm -rf "$dst"
  ln -sfn "$src" "$dst"
}

# install homebrew packages
brew bundle --file="$DOTFILES_SRC_ROOT/homebrew/Brewfile"

# install vscode extensions
brew bundle --file="$DOTFILES_SRC_ROOT/vscode/Brewfile"

# configure zsh
[ -d "$HOMEBREW_CELLAR/zsh" ] && {
  zsh_bin=$(brew --prefix)/bin/zsh
  if ! fgrep -q $zsh_bin /etc/shells; then
    echo $zsh_bin | sudo tee -a /etc/shells
    chsh -s $zsh_bin
  fi
  ln -fns "$root_path/zsh/zshrc" "$HOME/.zshrc"
}

# configure other apps
mkdir -p "$HOME/.config"
link_config "$DOTFILES_SRC_ROOT/btop" "$HOME/.config/btop"
link_config "$DOTFILES_SRC_ROOT/linearmouse" "$HOME/.config/linearmouse"
link_config "$DOTFILES_SRC_ROOT/mise" "$HOME/.config/mise"
link_config "$DOTFILES_SRC_ROOT/starship" "$HOME/.config/starship"
link_config "$DOTFILES_SRC_ROOT/vscode/settings.json" "$HOME/Library/Application Support/Code/User/settings.json"
