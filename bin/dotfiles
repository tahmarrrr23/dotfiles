#!/bin/sh
set -eu

DOTFILES_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
DOTFILES_SRC_ROOT="$DOTFILES_ROOT/src"

link_config() {
  local src=$1 dst=$2
  rm -rf "$dst"
  ln -sfn "$src" "$dst"
}

add_shell() {
  if ! grep -qx "$1" /etc/shells; then
    echo "$1" | sudo tee -a /etc/shells >/dev/null
  fi
}

remove_shell() {
  if grep -qx "$1" /etc/shells; then
    sudo sed -i.bak "\|^$1$|d" /etc/shells
  fi
}

change_shell() {
  if [ "$SHELL" != "$1" ]; then
    chsh -s "$1"
    exec $1 -l
  fi
}

target_shell="$HOMEBREW_PREFIX/bin/zsh"
if [ -x "$target_shell" ]; then
  add_shell "$target_shell"
  change_shell "$target_shell"
else
  remove_shell "$target_shell"
  change_shell "/bin/zsh"
fi

# configure
mkdir -p "$HOME/.config"
link_config "$DOTFILES_SRC_ROOT/atuin" "$HOME/.config/atuin"
link_config "$DOTFILES_SRC_ROOT/linearmouse" "$HOME/.config/linearmouse"
link_config "$DOTFILES_SRC_ROOT/mise" "$HOME/.config/mise"
link_config "$DOTFILES_SRC_ROOT/rio" "$HOME/.config/rio"
link_config "$DOTFILES_SRC_ROOT/sheldon" "$HOME/.config/sheldon"
link_config "$DOTFILES_SRC_ROOT/vscode/settings.json" "$HOME/Library/Application Support/Code/User/settings.json"
link_config "$DOTFILES_SRC_ROOT/zsh/zshrc" "$HOME/.zshrc"
