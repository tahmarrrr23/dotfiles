#!/usr/bin/env bash

set -e

root_directory="$(cd "$(dirname "$0")/.." && pwd)"
src_directory="$root_directory/src"

link_config() {
  local src=$1 dst=$2
  rm -rf "$dst"
  ln -sfn "$src" "$dst"
}

add_shell() {
  if ! grep -qx "$1" /etc/shells; then
    echo "$1" | sudo tee -a /etc/shells >/dev/null
  fi
}

remove_shell() {
  if grep -qx "$1" /etc/shells; then
    sudo sed -i.bak "\|^$1$|d" /etc/shells
  fi
}

change_shell() {
  if [ "$SHELL" != "$1" ]; then
    chsh -s "$1"
    exec $1 -l
  fi
}

printf "Configure zsh as default shell\n"
target_shell="$HOMEBREW_PREFIX/bin/zsh"
if [ -x "$target_shell" ]; then
  add_shell "$target_shell"
  change_shell "$target_shell"
else
  remove_shell "$target_shell"
  change_shell "/bin/zsh"
fi

printf "Configure\n"
mkdir -p "$HOME/.config"
link_config "$src_directory/atuin" "$HOME/.config/atuin"
link_config "$src_directory/linearmouse" "$HOME/.config/linearmouse"
link_config "$src_directory/mise" "$HOME/.config/mise"
link_config "$src_directory/rio" "$HOME/.config/rio"
link_config "$src_directory/sheldon" "$HOME/.config/sheldon"
link_config "$src_directory/vscode/settings.json" "$HOME/Library/Application Support/Code/User/settings.json"
link_config "$src_directory/zsh/zshrc" "$HOME/.zshrc"
